{"ast":null,"code":"import { monitor, Observable, timeStampNow } from '@datadog/browser-core';\nimport { LifeCycleEventType } from './lifeCycle'; // Delay to wait for a page activity to validate the tracking process\n\nexport var PAGE_ACTIVITY_VALIDATION_DELAY = 100; // Delay to wait after a page activity to end the tracking process\n\nexport var PAGE_ACTIVITY_END_DELAY = 100; // Maximum duration of the tracking process\n\nexport var PAGE_ACTIVITY_MAX_DURATION = 10000;\nexport function waitIdlePageActivity(lifeCycle, domMutationObservable, completionCallback) {\n  var _a = trackPageActivities(lifeCycle, domMutationObservable),\n      pageActivitiesObservable = _a.observable,\n      stopPageActivitiesTracking = _a.stop;\n\n  var stopWaitPageActivitiesCompletion = waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, completionCallback).stop;\n\n  var stop = function stop() {\n    stopWaitPageActivitiesCompletion();\n    stopPageActivitiesTracking();\n  };\n\n  return {\n    stop: stop\n  };\n} // Automatic action collection lifecycle overview:\n//                      (Start new trackPageActivities)\n//              .-------------------'--------------------.\n//              v                                        v\n//     [Wait for a page activity ]          [Wait for a maximum duration]\n//     [timeout: VALIDATION_DELAY]          [  timeout: MAX_DURATION    ]\n//          /                  \\                           |\n//         v                    v                          |\n//  [No page activity]   [Page activity]                   |\n//         |                   |,----------------------.   |\n//         v                   v                       |   |\n//     (Discard)     [Wait for a page activity]        |   |\n//                   [   timeout: END_DELAY   ]        |   |\n//                       /                \\            |   |\n//                      v                  v           |   |\n//             [No page activity]    [Page activity]   |   |\n//                      |                 |            |   |\n//                      |                 '------------'   |\n//                      '-----------. ,--------------------'\n//                                   v\n//                                 (End)\n//\n// Note: because MAX_DURATION > VALIDATION_DELAY, we are sure that if the process is still alive\n// after MAX_DURATION, it has been validated.\n\nexport function trackPageActivities(lifeCycle, domMutationObservable) {\n  var observable = new Observable();\n  var subscriptions = [];\n  var firstRequestIndex;\n  var pendingRequestsCount = 0;\n  subscriptions.push(domMutationObservable.subscribe(function () {\n    return notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, function (entry) {\n    if (entry.entryType !== 'resource') {\n      return;\n    }\n\n    notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_STARTED, function (startEvent) {\n    if (firstRequestIndex === undefined) {\n      firstRequestIndex = startEvent.requestIndex;\n    }\n\n    pendingRequestsCount += 1;\n    notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n    // If the request started before the tracking start, ignore it\n    if (firstRequestIndex === undefined || request.requestIndex < firstRequestIndex) {\n      return;\n    }\n\n    pendingRequestsCount -= 1;\n    notifyPageActivity();\n  }));\n\n  function notifyPageActivity() {\n    observable.notify({\n      isBusy: pendingRequestsCount > 0\n    });\n  }\n\n  return {\n    observable: observable,\n    stop: function stop() {\n      subscriptions.forEach(function (s) {\n        return s.unsubscribe();\n      });\n    }\n  };\n}\nexport function waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, completionCallback) {\n  var idleTimeoutId;\n  var hasCompleted = false;\n  var validationTimeoutId = setTimeout(monitor(function () {\n    return complete({\n      hadActivity: false\n    });\n  }), PAGE_ACTIVITY_VALIDATION_DELAY);\n  var maxDurationTimeoutId = setTimeout(monitor(function () {\n    return complete({\n      hadActivity: true,\n      endTime: timeStampNow()\n    });\n  }), PAGE_ACTIVITY_MAX_DURATION);\n  pageActivitiesObservable.subscribe(function (_a) {\n    var isBusy = _a.isBusy;\n    clearTimeout(validationTimeoutId);\n    clearTimeout(idleTimeoutId);\n    var lastChangeTime = timeStampNow();\n\n    if (!isBusy) {\n      idleTimeoutId = setTimeout(monitor(function () {\n        return complete({\n          hadActivity: true,\n          endTime: lastChangeTime\n        });\n      }), PAGE_ACTIVITY_END_DELAY);\n    }\n  });\n\n  var stop = function stop() {\n    hasCompleted = true;\n    clearTimeout(validationTimeoutId);\n    clearTimeout(idleTimeoutId);\n    clearTimeout(maxDurationTimeoutId);\n    stopPageActivitiesTracking();\n  };\n\n  function complete(params) {\n    if (hasCompleted) {\n      return;\n    }\n\n    stop();\n    completionCallback(params);\n  }\n\n  return {\n    stop: stop\n  };\n}","map":{"version":3,"sources":["../../src/domain/trackPageActivities.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { monitor, Observable, timeStampNow } from '@datadog/browser-core';\nimport { LifeCycleEventType } from './lifeCycle';\n// Delay to wait for a page activity to validate the tracking process\nexport var PAGE_ACTIVITY_VALIDATION_DELAY = 100;\n// Delay to wait after a page activity to end the tracking process\nexport var PAGE_ACTIVITY_END_DELAY = 100;\n// Maximum duration of the tracking process\nexport var PAGE_ACTIVITY_MAX_DURATION = 10000;\nexport function waitIdlePageActivity(lifeCycle, domMutationObservable, completionCallback) {\n    var _a = trackPageActivities(lifeCycle, domMutationObservable), pageActivitiesObservable = _a.observable, stopPageActivitiesTracking = _a.stop;\n    var stopWaitPageActivitiesCompletion = waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, completionCallback).stop;\n    var stop = function () {\n        stopWaitPageActivitiesCompletion();\n        stopPageActivitiesTracking();\n    };\n    return { stop: stop };\n}\n// Automatic action collection lifecycle overview:\n//                      (Start new trackPageActivities)\n//              .-------------------'--------------------.\n//              v                                        v\n//     [Wait for a page activity ]          [Wait for a maximum duration]\n//     [timeout: VALIDATION_DELAY]          [  timeout: MAX_DURATION    ]\n//          /                  \\                           |\n//         v                    v                          |\n//  [No page activity]   [Page activity]                   |\n//         |                   |,----------------------.   |\n//         v                   v                       |   |\n//     (Discard)     [Wait for a page activity]        |   |\n//                   [   timeout: END_DELAY   ]        |   |\n//                       /                \\            |   |\n//                      v                  v           |   |\n//             [No page activity]    [Page activity]   |   |\n//                      |                 |            |   |\n//                      |                 '------------'   |\n//                      '-----------. ,--------------------'\n//                                   v\n//                                 (End)\n//\n// Note: because MAX_DURATION > VALIDATION_DELAY, we are sure that if the process is still alive\n// after MAX_DURATION, it has been validated.\nexport function trackPageActivities(lifeCycle, domMutationObservable) {\n    var observable = new Observable();\n    var subscriptions = [];\n    var firstRequestIndex;\n    var pendingRequestsCount = 0;\n    subscriptions.push(domMutationObservable.subscribe(function () { return notifyPageActivity(); }));\n    subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, function (entry) {\n        if (entry.entryType !== 'resource') {\n            return;\n        }\n        notifyPageActivity();\n    }));\n    subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_STARTED, function (startEvent) {\n        if (firstRequestIndex === undefined) {\n            firstRequestIndex = startEvent.requestIndex;\n        }\n        pendingRequestsCount += 1;\n        notifyPageActivity();\n    }));\n    subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n        // If the request started before the tracking start, ignore it\n        if (firstRequestIndex === undefined || request.requestIndex < firstRequestIndex) {\n            return;\n        }\n        pendingRequestsCount -= 1;\n        notifyPageActivity();\n    }));\n    function notifyPageActivity() {\n        observable.notify({ isBusy: pendingRequestsCount > 0 });\n    }\n    return {\n        observable: observable,\n        stop: function () {\n            subscriptions.forEach(function (s) { return s.unsubscribe(); });\n        },\n    };\n}\nexport function waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, completionCallback) {\n    var idleTimeoutId;\n    var hasCompleted = false;\n    var validationTimeoutId = setTimeout(monitor(function () { return complete({ hadActivity: false }); }), PAGE_ACTIVITY_VALIDATION_DELAY);\n    var maxDurationTimeoutId = setTimeout(monitor(function () { return complete({ hadActivity: true, endTime: timeStampNow() }); }), PAGE_ACTIVITY_MAX_DURATION);\n    pageActivitiesObservable.subscribe(function (_a) {\n        var isBusy = _a.isBusy;\n        clearTimeout(validationTimeoutId);\n        clearTimeout(idleTimeoutId);\n        var lastChangeTime = timeStampNow();\n        if (!isBusy) {\n            idleTimeoutId = setTimeout(monitor(function () { return complete({ hadActivity: true, endTime: lastChangeTime }); }), PAGE_ACTIVITY_END_DELAY);\n        }\n    });\n    var stop = function () {\n        hasCompleted = true;\n        clearTimeout(validationTimeoutId);\n        clearTimeout(idleTimeoutId);\n        clearTimeout(maxDurationTimeoutId);\n        stopPageActivitiesTracking();\n    };\n    function complete(params) {\n        if (hasCompleted) {\n            return;\n        }\n        stop();\n        completionCallback(params);\n    }\n    return { stop: stop };\n}\n//# sourceMappingURL=trackPageActivities.js.map"]},"metadata":{},"sourceType":"module"}